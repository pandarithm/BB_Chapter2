---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r}
plot(cars)
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
```{r}
library(tidyverse)
NLbatting <- read.csv("NLbatting.csv")
ALbatting <- read.csv("ALbatting.csv")
batting <- bind_rows(NLbatting, ALbatting)
```

THe below chunk shows how to join pitching and batting data(columns) by each team(rows).
```{r}
NLpitching <- read.csv("NLpitching.csv")
NL <- inner_join(NLbatting, NLpitching, by = "Tm")
```

Filter teams with more than 150 home runs
```{r}
NLbatting %>% filter(HR >150) -> NL_150
```

Vectors:
"A sequence of values of a given type such as numeric or character"

The following code is analyzing the spahn wins vs losses

```{r}
W <- c(8, 21, 15, 21, 21, 22, 14)
L <- c(5, 10, 12, 14, 17, 14, 19)

Win.Pct <- 100 * W/ (W +L)
Win.Pct 
```
You can use the function "seq()" to create patterned data in a vector

```{r}
Year <- seq(from = 1946, to = 1952)
Year

#or use ":" for consecutive integer values

YearC <- 1946 : 1952
YearC
```
We will now calculate Spahn's age during these years(he was born in 1921: 
```{r}
Age <- Year - 1921

#plot the result

plot(Age, Win.Pct)
```
Vector Functions: 

```{r}
mean(Win.Pct)

#sort from high to low
sort(W)

#cumsum == cumulative totals of a vector
cumsum(W)

#summary() gives various statistics for the vector

summary(Win.Pct)
```
Vector index and logical Variables: 

```{r}
#to extract portions of a vector square brackets are used "[]"
W[c(1,2,5)]

#extract first 4 values of vector
W[1 : 4]

#using a minus index, we can remove items from the vector
W[-c(1, 6)]

#logical variable can also be created with logical operations
Win.Pct > 60

#win pct over 60 and won more than 20 games
(W > 20) & (Win.Pct > 60)

#highest winning pct
Win.Pct == max(Win.Pct)

#index year by the logical vector above
Year[Win.Pct == max(Win.Pct)]

#wins plus losses > 30 (total decisions)
Year[W + L > 30]
```
Objects and Containers in R

Character data and data frames

Setting up vecotrs to show winners of the World Series from 2008 - 2017

```{r}
Year <- 2008 : 2017

NL <- c("PHI", "PHI", "SFN", "SLN", "SFN", "SLN", "SFN", "NYN", "CHN", "LAN")

AL <- c("TBA", "NYA", "TEX", "TEX", "DET", "BOS", "KCA", "KCA", "CLE", "HOU" )

Winner <- c("NL", "AL", "NL",  "NL", "NL", "AL", "NL", "AL", "NL", "AL")

N_Games <- c(5, 6, 5, 7, 4, 7, 7, 5, 7, 7)
```

We will populate a dataframe with the vectors above
```{r}
WS_results <- tibble(
  Year = Year, NL_Team = NL, AL_Team = AL,
  N_Games = N_Games, Winner = Winner)

WS_results
```

To find patterns in text we can use grep. (Lets find the teams from New York that played in thees World Series)

```{r}
grep("NY", c(AL, NL), value = TRUE)
```
N = n() counts the number of rows and can only be used in summarize(), mutate(), and filter()

Lets find the number of wins by each league: 


```{r}
WS_results %>%
  group_by(Winner) %>%
  summarize(N = n()) -> WS

WS
```

lets graph the winners chart above with a bar chart

```{r}
ggplot(WS, aes(x = Winner, y = N)) + 
  geom_col()
```

Factors: 

A factor is a special way of representing character data
You can use mutate and factor to change the order of the vector within a data frame. This is a fringe use case but other cases may be more useful. Many R functions require the use of factors                                  

We will create a frequency table that sorts the teams by division(East, Central, West)

That order is NYN, PHI, CHN, SLN, LAN, SFN

```{r}
WS_results <- WS_results %>%
  mutate(NL_Team = factor(NL_Team, levels = c("NYN", "PHI", "CHN", "SLN", "LAN", "SFN")))

#To see how variables are stored in a factor use str()
str(WS_results$NL_Team)
```
Frequency chart
```{r}
WS_results %>%
  group_by(NL_Team) %>%
  summarise(N = n())
```
LISTS

Lists are a container that can contain data values of various types

```{r}
world_series <- list(Winner = Winner, Number.Games = N_Games, Seasons = "2008 to 2017")
```

Access different components of a list. IF we want to display the the number of games played - Number.Games, we can use the list variable name together with the $ symbol and component name

```{r}
world_series$Number.Games

#square brackets to display specific item in list
world_series[[2]]

#The pluck() function from purr also extracts elements from a list
pluck(world_series, "Number.Games")

#square brackets can also be used
world_series["Number.Games"]
```
Since a data.frame is a list, the dollar sign operator can be used to extract a vector from a data.frame as well
The pull() function does the same thing

```{r}
WS_results$NL_Team

pull(WS_results, NL_Team)
```
R Scripts: 

```{r}
library(tidyverse)
library(Lahman)
ws <- filter(SeriesPost, yearID >= 1903,
             round == "WS", wins + losses < 8)
ggplot(ws, aes(x = wins + losses)) + 
  geom_bar(fill = "#2905a1") + 
  labs(x = "Number of games", y = "Frequency")
```
Function: 

lets create a function to calculate the hr rates for a player over a collection of seasons

```{r}
hr_rates <- function(age, hr, ab) {
  rates <- round(100 * hr / ab, 1)
  list(x = age, y = rates)
}

#using data from Mickey Mantle
HR <- c(13, 23, 21, 27, 37, 52, 34, 42, 31, 40, 54)
AB <- c(341, 549, 461, 543, 517, 533, 474, 519, 541, 527, 514)
Age <- 19 : 29


#plot 
plot(hr_rates(Age, HR, AB))
```
Writing to a data set: 

Create a dataframe and then use write_csv()

```{r}
hr_rates <- function(age, hr, ab) {
  rates <- round(100 * hr / ab, 1)
  list(x = age, y = rates)
}

HR <- c(13, 23, 21, 27, 37, 52, 34, 42, 31, 40, 54)
AB <- c(341, 549, 461, 543, 517, 533, 474, 519, 541, 527, 514)
Age <- 19 : 29
hr_rates <- hr_rates(Age, HR, AB)
Mantle <- data.frame(Age, HR, AB, Rates = hr_rates$y)

#write to file
write.csv(Mantle, "mantle1.csv")
list.files("data", pattern = "mantle")
```
Lets look at the great HR hitters in baseball history

```{r}
Batting %>%
  filter(yearID >= 1960, yearID <= 1969) -> Batting_60

#now lets find the total number of home runs for each player in the data frame Batting_60
Batting_60 %>% 
  group_by(playerID) %>%
  summarize(HR = sum(HR)) -> hr_60

hr_60 %>%
  arrange(desc(HR)) -> hr_60
head(hr_60)

```
Now lets iterate an operation using map()
Lets find the player who hit the most home runs in each decade across baseball history

```{r}
#Function that takes data frame of batting statistics and returns one row with the player with the most HRs in that set

hr_leader <- function(data) {
  data %>%
    group_by(playerID) %>%
    summarise(HR = sum(HR)) %>%
    arrange(desc(HR)) %>% 
    head(1)
}  
#Now we will split the data into pieces based on the decade
  
Batting %>%
  mutate(decade = 10 * floor(yearID / 10)) %>%
  split(pull(., decade)) %>%
  map_df(hr_leader, .id = "decade")

```
Now lets find career stats for players with at least 5000 starts
```{r}
Batting %>%
  group_by(playerID) %>%
  summarise(tAB = sum(AB, na.rm = TRUE),
            tHR = sum(HR, na.rm = TRUE),
            tSO = sum(SO, na.rm = TRUE)) -> long_careers
```
```{r}
Batting_5000 <- filter(long_careers, tAB >= 5000)
head(Batting_5000)
```

```{r}
ggplot(Batting_5000, aes(x = tHR / tAB, y = tSO / tAB)) +
  geom_point() + geom_smooth()
```

